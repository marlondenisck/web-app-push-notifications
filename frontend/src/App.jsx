import { useState, useEffect } from 'react'
import axios from 'axios'

import './App.css'
import MrRobotSvg from './assets/mr-robot.svg'

function App() {
  const [apiData, setApiData] = useState(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState(null)
  const [notificationPermission, setNotificationPermission] = useState(Notification.permission)
  const [permissionBlocked, setPermissionBlocked] = useState(Notification.permission === 'denied')
  const [browserInfo, setBrowserInfo] = useState('')

  const formatTimestamp = (timestamp) => {
    const date = new Date(timestamp)
    return date.toLocaleString('pt-BR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      timeZone: 'America/Sao_Paulo'
    })
  }
  
  // Detecta o navegador atual para instruÃ§Ãµes especÃ­ficas
  useEffect(() => {
    const ua = navigator.userAgent
    let browserName = "seu navegador"
    
    if (ua.indexOf("Edg") > -1) browserName = "Microsoft Edge"
    else if (ua.indexOf("Chrome") > -1) browserName = "Google Chrome"
    else if (ua.indexOf("Firefox") > -1) browserName = "Firefox"
    else if (ua.indexOf("Safari") > -1) browserName = "Safari"
    
    setBrowserInfo(browserName)
  }, [])

  const requestNotificationPermission = async () => {
    if (!('Notification' in window)) {
      alert('Este navegador nÃ£o suporta notificaÃ§Ãµes')
      return
    }

    try {
      // Verificar se as permissÃµes jÃ¡ estÃ£o bloqueadas antes de solicitar
      if (Notification.permission === 'denied') {
        setPermissionBlocked(true)
        console.log('PermissÃ£o para notificaÃ§Ãµes jÃ¡ estÃ¡ bloqueada')
        return
      }
      
      // Melhorando a compatibilidade com o Edge
      // No Edge, Ã s vezes o mÃ©todo retorna uma Promise, outras vezes um valor direto
      const permission = await (
        typeof Notification.requestPermission === 'function' 
          ? Notification.requestPermission() 
          : new Promise((resolve) => Notification.requestPermission(resolve))
      )
      
      setNotificationPermission(permission)
      
      if (permission === 'granted') {
        console.log('PermissÃ£o para notificaÃ§Ãµes concedida')
        setPermissionBlocked(false)
        
        // Vamos garantir que o service worker estÃ¡ registrado
        if ('serviceWorker' in navigator) {
          try {
            await navigator.serviceWorker.ready
            console.log('Service worker estÃ¡ pronto')
          } catch (error) {
            console.error('Erro ao verificar service worker:', error)
          }
        }
      } else if (permission === 'denied') {
        console.log('PermissÃ£o para notificaÃ§Ãµes negada')
        setPermissionBlocked(true)
      } else {
        console.log('PermissÃ£o para notificaÃ§Ãµes foi adiada pelo usuÃ¡rio')
      }
    } catch (error) {
      console.error('Erro ao solicitar permissÃ£o:', error)
      alert('Ocorreu um erro ao solicitar permissÃ£o para notificaÃ§Ãµes')
    }
  }

  const testNotification = () => {
    if (notificationPermission !== 'granted') {
      alert('PermissÃ£o para notificaÃ§Ãµes nÃ£o foi concedida')
      return
    }

    // Teste de notificaÃ§Ã£o simples
    /** 
      Contexto: Executa no contexto da aba/pÃ¡gina ativa
      LimitaÃ§Ãµes:
        SÃ³ funciona enquanto a aba estiver aberta
        Se o usuÃ¡rio fechar a aba, nÃ£o pode mais enviar notificaÃ§Ãµes
        NÃ£o persiste se a pÃ¡gina for recarregada
      Uso: NotificaÃ§Ãµes imediatas e simples
     */
    new Notification('Teste de NotificaÃ§Ã£o', {
      body: 'Esta Ã© uma notificaÃ§Ã£o simples de teste!',
      icon: MrRobotSvg
    })
  }

  const testServiceWorkerNotification = async () => {
    if (notificationPermission !== 'granted') {
      alert('PermissÃ£o para notificaÃ§Ãµes nÃ£o foi concedida')
      return
    }

    /**
        Contexto: Executa em background, independente da pÃ¡gina
        Vantagens:
          Funciona mesmo com a aba fechada
          Persiste entre sessÃµes do navegador
          Pode receber push notifications do servidor
          Permite aÃ§Ãµes customizadas (botÃµes na notificaÃ§Ã£o)
          Suporta notificaÃ§Ãµes offline
     */
    try {
      // Verificar se o service worker estÃ¡ disponÃ­vel
      if (!('serviceWorker' in navigator)) {
        alert('ServiceWorker nÃ£o Ã© suportado neste navegador')
        return
      }

      // Garantir que o service worker estÃ¡ registrado e ativo
      const registration = await navigator.serviceWorker.ready
      console.log('Service worker pronto para enviar notificaÃ§Ã£o:', registration)
      
      // Enviar a notificaÃ§Ã£o atravÃ©s do service worker
      await registration.showNotification('Teste via Service Worker', {
        body: 'Esta notificaÃ§Ã£o foi enviada pelo Service Worker!',
        icon: MrRobotSvg,
        tag: 'test-notification', // Ajuda a prevenir mÃºltiplas notificaÃ§Ãµes iguais
        requireInteraction: true, // MantÃ©m a notificaÃ§Ã£o atÃ© o usuÃ¡rio interagir
        vibrate: [100, 50, 100], // PadrÃ£o de vibraÃ§Ã£o (ms)
        data: {
          url: window.location.href // URL para abrir quando clicar na notificaÃ§Ã£o
        }
      })
      
      console.log('NotificaÃ§Ã£o do service worker enviada com sucesso')
    } catch (error) {
      console.error('Erro ao enviar notificaÃ§Ã£o via service worker:', error)
      alert('Erro ao enviar notificaÃ§Ã£o via Service Worker: ' + error.message)
    }
  }

  // Verificar o status das permissÃµes de notificaÃ§Ã£o ao carregar o componente
  useEffect(() => {
    // Verificar se o navegador suporta notificaÃ§Ãµes
    if ('Notification' in window) {
      const currentPermission = Notification.permission
      setNotificationPermission(currentPermission)
      
      // Atualizar o estado se as permissÃµes jÃ¡ estiverem negadas
      if (currentPermission === 'denied') {
        setPermissionBlocked(true)
        console.log('PermissÃµes de notificaÃ§Ã£o jÃ¡ estÃ£o bloqueadas')
      }
    }
  }, [])

  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true)
        const response = await axios.get('http://localhost:3001/')
        setApiData(response.data)
        setError(null)
      } catch (err) {
        setError('Erro ao conectar com a API: ' + err.message)
        setApiData(null)
      } finally {
        setLoading(false)
      }
    }

    fetchData()
  }, [])

  const handleRefresh = () => {
    setApiData(null)
    setError(null)
    setLoading(true)
    
    axios.get('http://localhost:3001/')
      .then(response => {
        setApiData(response.data)
        setError(null)
      })
      .catch(err => {
        setError('Erro ao conectar com a API: ' + err.message)
        setApiData(null)
      })
      .finally(() => {
        setLoading(false)
      })
  }

  return (
    <>
      <div className="card">
        <h2>Dados da API:</h2>
        
        {loading && <p>Carregando...</p>}
        
        {error && (
          <div style={{ color: 'red', margin: '10px 0' }}>
            <p>{error}</p>
          </div>
        )}
        
        {apiData && (
          <div style={{ 
            background: '#f0f0f0', 
            padding: '15px', 
            borderRadius: '8px', 
            margin: '10px 0',
            color: '#333'
          }}>
            <p><strong>Mensagem:</strong> {apiData.message}</p>
            <p><strong>Timestamp:</strong> {formatTimestamp(apiData.timestamp)}</p>
            <p><strong>Status:</strong> {apiData.status}</p>
          </div>
        )}
        
        <button onClick={handleRefresh} disabled={loading}>
          {loading ? 'Carregando...' : 'Atualizar Dados'}
        </button>
        
        <div style={{ marginTop: '20px', borderTop: '1px solid #ccc', paddingTop: '20px' }}>
          <h3>Teste de NotificaÃ§Ãµes</h3>
          
          <p>Status da permissÃ£o: <strong>{notificationPermission}</strong></p>
          
          {permissionBlocked && (
            <div style={{ 
              background: '#fff3cd', 
              color: '#856404', 
              padding: '15px', 
              borderRadius: '5px', 
              marginBottom: '15px',
              border: '1px solid #ffeeba'
            }}>
              <h4 style={{ margin: '0 0 10px 0' }}>ðŸš« PermissÃµes de notificaÃ§Ã£o bloqueadas</h4>
              <p>
                As notificaÃ§Ãµes foram bloqueadas porque os prompts de permissÃ£o foram ignorados vÃ¡rias vezes.
              </p>
              <p>
                <strong>Para desbloquear no {browserInfo}:</strong>
                {browserInfo === "Microsoft Edge" && (
                  <span>
                    Clique no Ã­cone de cadeado ou Ã­cone de ajuste (ðŸ”’) ao lado da URL, 
                    selecione "ConfiguraÃ§Ãµes do site" e altere a configuraÃ§Ã£o de notificaÃ§Ãµes para "Permitir".
                  </span>
                )}
                {browserInfo === "Google Chrome" && (
                  <span>
                    Clique no Ã­cone de cadeado (ðŸ”’) ao lado da URL, 
                    selecione "ConfiguraÃ§Ãµes do site" e altere a configuraÃ§Ã£o de notificaÃ§Ãµes para "Permitir".
                  </span>
                )}
                {browserInfo === "Firefox" && (
                  <span>
                    Clique no Ã­cone de cadeado (ðŸ”’) ao lado da URL, 
                    clique no "X" ao lado de "Bloquear notificaÃ§Ãµes" para removÃª-lo.
                  </span>
                )}
                {browserInfo === "Safari" && (
                  <span>
                    Abra as PreferÃªncias do Safari â†’ Websites â†’ NotificaÃ§Ãµes e altere as permissÃµes para este site.
                  </span>
                )}
                {!["Microsoft Edge", "Google Chrome", "Firefox", "Safari"].includes(browserInfo) && (
                  <span>
                    Verifique as configuraÃ§Ãµes de notificaÃ§Ã£o nas preferÃªncias do site ou nas configuraÃ§Ãµes de privacidade do navegador.
                  </span>
                )}
              </p>
            </div>
          )}
          
          <div style={{ display: 'flex', gap: '10px', flexWrap: 'wrap', marginTop: '10px' }}>
            <button onClick={requestNotificationPermission}>
              Solicitar PermissÃ£o
            </button>
            
            <button onClick={testNotification} disabled={notificationPermission !== 'granted'}>
              Teste NotificaÃ§Ã£o Simples
            </button>
            
            <button onClick={testServiceWorkerNotification} disabled={notificationPermission !== 'granted'}>
              Teste via Service Worker
            </button>
          </div>
        </div>
        
      
      </div>
    </>
  )
}

export default App
